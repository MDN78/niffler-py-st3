{"uid":"d0cce2d8a6520121","name":"Message Should Be Produced To Userdata After Kafka Event","fullName":"tests.kafka.test_kafka.TestAuthRegistrationKafka#test_message_should_be_produced_to_userdata_after_kafka_event","historyId":"f7dd2ad9657299d5a2797ec73c0107e0","time":{"start":1770311991946,"stop":1770311992058,"duration":112},"status":"broken","statusMessage":"sqlalchemy.exc.NoResultFound: No row was found when one was required","statusTrace":"self = <tests.kafka.test_kafka.TestAuthRegistrationKafka object at 0x7f33d1476e90>\nkafka = <clients.kafka_client.KafkaClient object at 0x7f33cf9b6cf0>\nauth_db = <databases.auth_db.UserDb object at 0x7f33cf9b7770>\nuser_db = <databases.userdata_db.UserdataDb object at 0x7f33cf9b7cb0>\n\n    @allure.story(AllureStory.KAFKA_PRODUCING)\n    def test_message_should_be_produced_to_userdata_after_kafka_event(self, kafka, auth_db: UserDb,\n                                                                      user_db: UserdataDb):\n        username = fake.user_name()\n    \n        kafka.sent_event(KAFKA_TOPIC, username)\n        check_new_record_in_auth_db(auth_db, username)\n>       check_new_record_in_user_db(user_db, username)\n\ntests/kafka/test_kafka.py:47: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \ntools/assertions/kafka.py:50: in check_new_record_in_user_db\n    user_db = user_db.get_user(username).username\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^\ndatabases/userdata_db.py:34: in get_user\n    return session.exec(statement).one()\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n.venv/lib/python3.13/site-packages/sqlalchemy/engine/result.py:1815: in one\n    return self._only_one_row(\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nself = <sqlalchemy.engine.result.ScalarResult object at 0x7f33cf5a4140>\nraise_for_second_row = True, raise_for_none = True, scalar = False\n\n    def _only_one_row(\n        self,\n        raise_for_second_row: bool,\n        raise_for_none: bool,\n        scalar: bool,\n    ) -> Optional[_R]:\n        onerow = self._fetchone_impl\n    \n        row: Optional[_InterimRowType[Any]] = onerow(hard_close=True)\n        if row is None:\n            if raise_for_none:\n>               raise exc.NoResultFound(\n                    \"No row was found when one was required\"\n                )\nE               sqlalchemy.exc.NoResultFound: No row was found when one was required\n\n.venv/lib/python3.13/site-packages/sqlalchemy/engine/result.py:760: NoResultFound","flaky":false,"newFailed":false,"newBroken":false,"newPassed":false,"retriesCount":0,"retriesStatusChange":false,"beforeStages":[{"name":"[S]  Verify Url","time":{"start":1770311981079,"stop":1770311981079,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"[S] Base Url","time":{"start":1770311981079,"stop":1770311981079,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"[S]  Session Faker","time":{"start":1770311981080,"stop":1770311981081,"duration":1},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"[S] Pytestconfig","time":{"start":1770311981080,"stop":1770311981080,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"[S] Delete Output Dir","time":{"start":1770311981080,"stop":1770311981080,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"[S] Envs","time":{"start":1770311981082,"stop":1770311981084,"duration":2},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"[S] Save Allure Environment File","time":{"start":1770311981084,"stop":1770311981084,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"[S] Kafka","time":{"start":1770311991466,"stop":1770311991469,"duration":3},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"[S] Auth Db","time":{"start":1770311991944,"stop":1770311991945,"duration":1},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"[F] User Db","time":{"start":1770311991945,"stop":1770311991945,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false}],"testStage":{"status":"broken","statusMessage":"sqlalchemy.exc.NoResultFound: No row was found when one was required","statusTrace":"self = <tests.kafka.test_kafka.TestAuthRegistrationKafka object at 0x7f33d1476e90>\nkafka = <clients.kafka_client.KafkaClient object at 0x7f33cf9b6cf0>\nauth_db = <databases.auth_db.UserDb object at 0x7f33cf9b7770>\nuser_db = <databases.userdata_db.UserdataDb object at 0x7f33cf9b7cb0>\n\n    @allure.story(AllureStory.KAFKA_PRODUCING)\n    def test_message_should_be_produced_to_userdata_after_kafka_event(self, kafka, auth_db: UserDb,\n                                                                      user_db: UserdataDb):\n        username = fake.user_name()\n    \n        kafka.sent_event(KAFKA_TOPIC, username)\n        check_new_record_in_auth_db(auth_db, username)\n>       check_new_record_in_user_db(user_db, username)\n\ntests/kafka/test_kafka.py:47: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \ntools/assertions/kafka.py:50: in check_new_record_in_user_db\n    user_db = user_db.get_user(username).username\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^\ndatabases/userdata_db.py:34: in get_user\n    return session.exec(statement).one()\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n.venv/lib/python3.13/site-packages/sqlalchemy/engine/result.py:1815: in one\n    return self._only_one_row(\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nself = <sqlalchemy.engine.result.ScalarResult object at 0x7f33cf5a4140>\nraise_for_second_row = True, raise_for_none = True, scalar = False\n\n    def _only_one_row(\n        self,\n        raise_for_second_row: bool,\n        raise_for_none: bool,\n        scalar: bool,\n    ) -> Optional[_R]:\n        onerow = self._fetchone_impl\n    \n        row: Optional[_InterimRowType[Any]] = onerow(hard_close=True)\n        if row is None:\n            if raise_for_none:\n>               raise exc.NoResultFound(\n                    \"No row was found when one was required\"\n                )\nE               sqlalchemy.exc.NoResultFound: No row was found when one was required\n\n.venv/lib/python3.13/site-packages/sqlalchemy/engine/result.py:760: NoResultFound","steps":[{"name":"DB: attach sql","time":{"start":1770311992002,"stop":1770311992003,"duration":1},"status":"passed","steps":[],"attachments":[{"uid":"8d4dc2c901691add","name":"select niffler-auth","source":"8d4dc2c901691add.txt","type":"text/plain","size":27}],"parameters":[{"name":"cursor","value":"<cursor object at 0x7f33cf5667a0; closed: 0>"},{"name":"statement","value":"'select pg_catalog.version()'"},{"name":"parameters","value":"immutabledict({})"},{"name":"context","value":"<sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7f33cf580980>"}],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":1,"hasContent":true,"attachmentStep":false},{"name":"DB: attach sql","time":{"start":1770311992008,"stop":1770311992008,"duration":0},"status":"passed","steps":[],"attachments":[{"uid":"78fd948f254dcd45","name":"select niffler-auth","source":"78fd948f254dcd45.txt","type":"text/plain","size":23}],"parameters":[{"name":"cursor","value":"<cursor object at 0x7f33cf5667a0; closed: 0>"},{"name":"statement","value":"'select current_schema()'"},{"name":"parameters","value":"immutabledict({})"},{"name":"context","value":"<sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7f33cf54b4d0>"}],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":1,"hasContent":true,"attachmentStep":false},{"name":"DB: attach sql","time":{"start":1770311992012,"stop":1770311992013,"duration":1},"status":"passed","steps":[],"attachments":[{"uid":"b831495766d7d6fd","name":"show niffler-auth","source":"b831495766d7d6fd.txt","type":"text/plain","size":32}],"parameters":[{"name":"cursor","value":"<cursor object at 0x7f33cf5667a0; closed: 0>"},{"name":"statement","value":"'show standard_conforming_strings'"},{"name":"parameters","value":"immutabledict({})"},{"name":"context","value":"<sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7f33cf54b4d0>"}],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":1,"hasContent":true,"attachmentStep":false},{"name":"DB: attach sql","time":{"start":1770311992032,"stop":1770311992033,"duration":1},"status":"passed","steps":[],"attachments":[{"uid":"10afd8933f7eea37","name":"SELECT niffler-auth","source":"10afd8933f7eea37.txt","type":"text/plain","size":216}],"parameters":[{"name":"cursor","value":"<cursor object at 0x7f33cf598a90; closed: 0>"},{"name":"statement","value":"'SELECT \"user\".id, \"user\".username, \"user\".password, \"user\".enabled, \"user\".account_non_expired, \"user\".account_non_locked, \"user\".credentials_non_expired \nFROM \"user\" \nWHERE \"user\".username = %(username_1)s'"},{"name":"parameters","value":"{'username_1': 'user_58567_amandasanchez'}"},{"name":"context","value":"<sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7f33d061f490>"}],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":1,"hasContent":true,"attachmentStep":false},{"name":"Check that 'record in auth db' equals to None","time":{"start":1770311992035,"stop":1770311992036,"duration":1},"status":"passed","steps":[],"attachments":[],"parameters":[{"name":"actual","value":"None"},{"name":"expected","value":"None"},{"name":"name","value":"'record in auth db'"}],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":true,"attachmentStep":false},{"name":"DB: attach sql","time":{"start":1770311992051,"stop":1770311992052,"duration":1},"status":"passed","steps":[],"attachments":[{"uid":"b4ac1badda4b49b8","name":"select niffler-userdata","source":"b4ac1badda4b49b8.txt","type":"text/plain","size":27}],"parameters":[{"name":"cursor","value":"<cursor object at 0x7f33d075bf10; closed: 0>"},{"name":"statement","value":"'select pg_catalog.version()'"},{"name":"parameters","value":"immutabledict({})"},{"name":"context","value":"<sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7f33d061f950>"}],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":1,"hasContent":true,"attachmentStep":false},{"name":"DB: attach sql","time":{"start":1770311992052,"stop":1770311992053,"duration":1},"status":"passed","steps":[],"attachments":[{"uid":"46c4faf378e40605","name":"select niffler-userdata","source":"46c4faf378e40605.txt","type":"text/plain","size":23}],"parameters":[{"name":"cursor","value":"<cursor object at 0x7f33d075bf10; closed: 0>"},{"name":"statement","value":"'select current_schema()'"},{"name":"parameters","value":"immutabledict({})"},{"name":"context","value":"<sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7f33d07e9910>"}],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":1,"hasContent":true,"attachmentStep":false},{"name":"DB: attach sql","time":{"start":1770311992053,"stop":1770311992053,"duration":0},"status":"passed","steps":[],"attachments":[{"uid":"f7904c1ae7652158","name":"show niffler-userdata","source":"f7904c1ae7652158.txt","type":"text/plain","size":32}],"parameters":[{"name":"cursor","value":"<cursor object at 0x7f33d075bf10; closed: 0>"},{"name":"statement","value":"'show standard_conforming_strings'"},{"name":"parameters","value":"immutabledict({})"},{"name":"context","value":"<sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7f33cf52b570>"}],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":1,"hasContent":true,"attachmentStep":false},{"name":"DB: attach sql","time":{"start":1770311992056,"stop":1770311992056,"duration":0},"status":"passed","steps":[],"attachments":[{"uid":"f4980c036cf0a8c7","name":"SELECT niffler-userdata","source":"f4980c036cf0a8c7.txt","type":"text/plain","size":199}],"parameters":[{"name":"cursor","value":"<cursor object at 0x7f33cf598a90; closed: 0>"},{"name":"statement","value":"'SELECT \"user\".id, \"user\".username, \"user\".currency, \"user\".firstname, \"user\".surname, \"user\".photo, \"user\".photo_small, \"user\".full_name \nFROM \"user\" \nWHERE \"user\".username = %(username_1)s'"},{"name":"parameters","value":"{'username_1': 'user_58567_amandasanchez'}"},{"name":"context","value":"<sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7f33cf52b570>"}],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":1,"hasContent":true,"attachmentStep":false}],"attachments":[{"uid":"92315b6312710d1d","name":"log","source":"92315b6312710d1d.txt","type":"text/plain","size":734}],"parameters":[],"stepsCount":9,"shouldDisplayMessage":true,"attachmentsCount":9,"hasContent":true,"attachmentStep":false},"afterStages":[{"name":"kafka::0","time":{"start":1770311992701,"stop":1770311994550,"duration":1849},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"save_allure_environment_file::0","time":{"start":1770311994603,"stop":1770311994603,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false}],"labels":[{"name":"story","value":"Filling userdata exclude auth"},{"name":"epic","value":"Niffler app"},{"name":"tag","value":"Паблишинг сообщений в кафку"},{"name":"feature","value":"Publishing messages to Kafka"},{"name":"parentSuite","value":"tests.kafka"},{"name":"suite","value":"test_kafka"},{"name":"subSuite","value":"TestAuthRegistrationKafka"},{"name":"host","value":"runnervmkj6or"},{"name":"thread","value":"9900-MainThread"},{"name":"framework","value":"pytest"},{"name":"language","value":"cpython3"},{"name":"package","value":"tests.kafka.test_kafka"},{"name":"resultFormat","value":"allure2"}],"parameters":[],"links":[],"hidden":false,"retry":false,"extra":{"severity":"normal","retries":[],"categories":[{"name":"Test defects","matchedStatuses":[],"flaky":false}],"tags":["Паблишинг сообщений в кафку"]},"source":"d0cce2d8a6520121.json","parameterValues":[]}